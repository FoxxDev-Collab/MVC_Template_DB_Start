@using HLE.FamilyFinance.Services.Interfaces
@using HLE.FamilyFinance.Models.ViewModels
@using HLE.FamilyFinance.Helpers
@model PagedResult<TransactionListItemDto>
@{
    ViewData["Title"] = "Transactions";
    var filter = ViewData["Filter"] as TransactionFilterViewModel ?? new TransactionFilterViewModel();
}

<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Transactions</h2>
        <div class="btn-group">
            <a asp-action="Create" class="btn btn-primary">+ Add Transaction</a>
            <a asp-action="Transfer" class="btn btn-outline-primary">Transfer</a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Account</label>
                    <select asp-for="@filter.AccountId" asp-items="@(ViewData["Accounts"] as SelectList)" class="form-select" name="AccountId">
                        <option value="">All Accounts</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select asp-for="@filter.CategoryId" asp-items="@(ViewData["Categories"] as SelectList)" class="form-select" name="CategoryId">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select asp-for="@filter.Type" asp-items="@(ViewData["TransactionTypes"] as SelectList)" class="form-select" name="Type">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" name="StartDate" value="@filter.StartDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" name="EndDate" value="@filter.EndDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-secondary me-2">Filter</button>
                    <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.TotalCount == 0)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <p class="text-muted mb-3">No transactions found. Add your first transaction to start tracking.</p>
                <a asp-action="Create" class="btn btn-primary">Add Transaction</a>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Account</th>
                            <th class="text-end">Amount</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in Model.Items)
                        {
                            <tr>
                                <td>@transaction.Date.ToString("MMM d, yyyy")</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(transaction.Payee))
                                    {
                                        <strong>@transaction.Payee</strong>
                                        @if (!string.IsNullOrEmpty(transaction.Description))
                                        {
                                            <br /><small class="text-muted">@transaction.Description</small>
                                        }
                                    }
                                    else if (!string.IsNullOrEmpty(transaction.Description))
                                    {
                                        @transaction.Description
                                    }
                                    else
                                    {
                                        <span class="text-muted">â€”</span>
                                    }
                                    @if (transaction.IsRecurring)
                                    {
                                        <span class="badge bg-info ms-1" title="Recurring">R</span>
                                    }
                                </td>
                                <td>
                                    @if (transaction.CategoryName != null)
                                    {
                                        var txCatIcon = transaction.CategoryIcon ?? "";
                                        var txCatStyle = !string.IsNullOrEmpty(transaction.CategoryColor) ? $"color: {transaction.CategoryColor}" : "";
                                        @if (txCatIcon.StartsWith("bi-"))
                                        {
                                            <i class="@txCatIcon me-1" style="@txCatStyle"></i>
                                        }
                                        else if (!string.IsNullOrEmpty(txCatIcon))
                                        {
                                            <span class="me-1" style="@txCatStyle">@txCatIcon</span>
                                        }
                                        <span>@transaction.CategoryName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Uncategorized</span>
                                    }
                                </td>
                                <td>@transaction.AccountName</td>
                                <td class="text-end">
                                    @{
                                        var amountClass = transaction.Type switch
                                        {
                                            HLE.FamilyFinance.Models.Enums.TransactionType.Income => "text-success",
                                            HLE.FamilyFinance.Models.Enums.TransactionType.Expense => "text-danger",
                                            _ => "text-primary"
                                        };
                                        var prefix = transaction.Type switch
                                        {
                                            HLE.FamilyFinance.Models.Enums.TransactionType.Income => "+",
                                            HLE.FamilyFinance.Models.Enums.TransactionType.Expense => "-",
                                            _ => ""
                                        };
                                    }
                                    <span class="@amountClass">@prefix$@transaction.Amount.ToString("N2")</span>
                                </td>
                                <td class="text-end">
                                    <a asp-action="Details" asp-route-id="@transaction.Id" class="btn btn-sm btn-outline-primary">View</a>
                                    <a asp-action="Edit" asp-route-id="@transaction.Id" class="btn btn-sm btn-outline-secondary">Edit</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (Model.TotalPages > 1)
            {
                <div class="card-footer">
                    <nav>
                        <ul class="pagination mb-0 justify-content-center">
                            @if (filter.Page > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-Page="@(filter.Page - 1)"
                                       asp-route-AccountId="@filter.AccountId" asp-route-CategoryId="@filter.CategoryId"
                                       asp-route-Type="@filter.Type" asp-route-StartDate="@filter.StartDate"
                                       asp-route-EndDate="@filter.EndDate">Previous</a>
                                </li>
                            }
                            @for (var i = Math.Max(1, filter.Page - 2); i <= Math.Min(Model.TotalPages, filter.Page + 2); i++)
                            {
                                <li class="page-item @(i == filter.Page ? "active" : "")">
                                    <a class="page-link" asp-action="Index" asp-route-Page="@i"
                                       asp-route-AccountId="@filter.AccountId" asp-route-CategoryId="@filter.CategoryId"
                                       asp-route-Type="@filter.Type" asp-route-StartDate="@filter.StartDate"
                                       asp-route-EndDate="@filter.EndDate">@i</a>
                                </li>
                            }
                            @if (filter.Page < Model.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-Page="@(filter.Page + 1)"
                                       asp-route-AccountId="@filter.AccountId" asp-route-CategoryId="@filter.CategoryId"
                                       asp-route-Type="@filter.Type" asp-route-StartDate="@filter.StartDate"
                                       asp-route-EndDate="@filter.EndDate">Next</a>
                                </li>
                            }
                        </ul>
                    </nav>
                    <p class="text-muted text-center small mb-0 mt-2">
                        Showing @((filter.Page - 1) * 25 + 1)-@Math.Min(filter.Page * 25, Model.TotalCount) of @Model.TotalCount transactions
                    </p>
                </div>
            }
        </div>
    }
</div>
